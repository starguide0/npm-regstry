name: Version Packages

on:
  push:
    branches:
      - main

jobs:
  version:
    # 봇이 생성한 버전 커밋("ci: version packages...")에 대해서는 실행되지 않도록 하여 중복 실행 방지
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      # 액션이 main 브랜치에 커밋을 푸시하기 위해 contents: write 권한이 필요합니다.
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # GITHUB_TOKEN을 사용하여 main 브랜치에 푸시할 수 있도록 설정합니다.
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js and pnpm
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Version & Update Changelogs
        run: pnpm changeset version
          # 이 명령어가 package.json 버전 업데이트와 CHANGELOG.md 파일을 생성/수정합니다.

      - name: Commit & Push version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 'changeset version' 실행 후 변경된 파일이 있는지 확인합니다.
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            git commit -m "ci: version packages and update changelogs"
            git push
          else
            echo "No version changes to commit."
          fi